import streamlit as st
import pandas as pd
import plotly.express as px
from datetime import datetime

st.set_page_config(page_title="Dashboard de Logins - Academia", layout="wide")

uploaded_file = st.sidebar.file_uploader("ðŸ“„ Envie o arquivo de logins (CSV)", type=["csv"])

if uploaded_file:
    df = pd.read_csv(uploaded_file, parse_dates=["timestamp"])
    df['timestamp'] = df['timestamp'].dt.tz_localize(None)  # <<< REMOVE o timezone aqui

    df['date'] = df['timestamp'].dt.normalize()
    df['week'] = df['timestamp'].dt.strftime('%Y-%U')
    df['day_of_week'] = df['timestamp'].dt.day_name()
    df['hour'] = df['timestamp'].dt.hour

    st.sidebar.subheader("ðŸ” Filtros")
    date_range = st.sidebar.date_input("PerÃ­odo", [df['date'].min().date(), df['date'].max().date()])
    selected_users = st.sidebar.multiselect("UsuÃ¡rios", df['user_id'].unique(), default=df['user_id'].unique())

    st.title(f"ðŸ‹ï¸â€â™‚ï¸ Logins Semanais ({date_range[0]} atÃ© {date_range[1]})")

    start_date = pd.Timestamp(date_range[0])
    end_date = pd.Timestamp(date_range[1])

    df_filtered = df[
        (df['date'] >= start_date) &
        (df['date'] <= end_date) &
        (df['user_id'].isin(selected_users))
    ]

    col1, col2, col3 = st.columns(3)
    col1.metric("ðŸ‘¥ UsuÃ¡rios Ãºnicos", df_filtered['user_id'].nunique())
    col2.metric("ðŸ”¢ Logins totais", len(df_filtered))
    col3.metric("ðŸ“Š MÃ©dia por usuÃ¡rio", round(len(df_filtered) / max(df_filtered['user_id'].nunique(), 1), 2))

    st.markdown("---")

    st.subheader("ðŸ“… Logins por Dia")
    daily_counts = df_filtered.groupby('date').size().reset_index(name='logins')
    fig1 = px.line(daily_counts, x='date', y='logins', title='Logins por Dia')
    st.plotly_chart(fig1, use_container_width=True)

    st.subheader("â° Heatmap de HorÃ¡rios")
    heatmap_data = df_filtered.groupby(['day_of_week', 'hour']).size().unstack().fillna(0)
    st.dataframe(heatmap_data.style.background_gradient(cmap='Blues'), height=300)

    st.subheader("ðŸ“ˆ Logins Semanais")
    weekly_counts = df_filtered.groupby('week').size().reset_index(name='logins')
    fig2 = px.bar(weekly_counts, x='week', y='logins', title='Total de Logins por Semana')
    st.plotly_chart(fig2, use_container_width=True)

    st.subheader("ðŸ“‹ Tabela de Logins")
    st.dataframe(df_filtered.sort_values(by="timestamp", ascending=False), height=300)

else:
    st.warning("âš ï¸ FaÃ§a upload de um arquivo CSV com colunas user_id e timestamp.")



ARQUIVO CSV:

user_id,timestamp
1,2025-04-29T10:15:00Z
2,2025-04-29T11:00:00Z
3,2025-04-29T11:45:00Z
4,2025-04-29T12:30:00Z
5,2025-04-29T13:15:00Z
1,2025-04-30T09:00:00Z
2,2025-04-30T10:45:00Z
3,2025-04-30T12:30:00Z
4,2025-04-30T13:15:00Z
5,2025-04-30T14:00:00Z
1,2025-05-01T08:30:00Z
2,2025-05-01T09:15:00Z
3,2025-05-01T10:00:00Z
4,2025-05-01T11:45:00Z
5,2025-05-01T12:30:00Z
1,2025-05-02T07:45:00Z
2,2025-05-02T08:30:00Z
3,2025-05-02T09:15:00Z
4,2025-05-02T10:00:00Z
5,2025-05-02T10:45:00Z
1,2025-05-03T11:00:00Z
2,2025-05-03T11:45:00Z
3,2025-05-03T12:30:00Z
4,2025-05-03T13:15:00Z
5,2025-05-03T14:00:00Z
1,2025-05-04T08:00:00Z
2,2025-05-04T09:00:00Z
3,2025-05-04T10:00:00Z
4,2025-05-04T11:00:00Z
5,2025-05-04T12:00:00Z
1,2025-05-05T07:00:00Z
2,2025-05-05T08:00:00Z
3,2025-05-05T09:00:00Z
4,2025-05-05T10:00:00Z
5,2025-05-05T11:00:00Z






